# 陪你天气 - 业务状态说明文档

## 概述

本文档详细说明"陪你天气"天气保障业务中的各种订单状态、补偿状态及其业务逻辑。

---

## 一、订单状态体系

### 1. 待支付

**状态码：** `待支付`
**状态颜色：** 橙色 (`bg-orange-100 text-orange-600`)

**定义：**
- 用户已生成报价信息，但尚未完成付款
- 订单已创建，但未激活保障

**业务规则：**
- 用户可以选择支付或取消订单
- 订单不会进入保障期
- weatherData 为空数组
- totalCompensation 为 0

**用户操作：**
- ✅ 立即支付
- ✅ 取消订单
- ❌ 不能申请退款

---

### 2. 已支付

**状态码：** `已支付`
**状态颜色：** 青色 (`bg-cyan-100 text-cyan-600`)

**定义：**
- 用户已完成付款，但保障开始日期未到
- 订单处于等待生效状态

**业务规则：**
- 保障将在指定的开始日期自动生效
- weatherData 为空数组（尚未开始监测）
- totalCompensation 为 0
- 显示"等待保障生效"状态卡片
- 显示保障开始日期和补偿规则预览

**用户操作：**
- ✅ 申请退款（保障未开始，可以全额退款）
- ✅ 联系客服
- ❌ 不能修改保障日期

**退款规则：**
- 由于保障期尚未开始，退款将自动处理
- 款项在 1-3 个工作日内原路退回

---

### 3. 保障中

**状态码：** `保障中`
**状态颜色：** 蓝色 (`bg-blue-100 text-blue-600`)

**定义：**
- 用户已付款，且当前日期在保障期内
- 系统正在实时监测天气并处理补偿

**业务规则：**
- 每天 08:00-20:00 监测降雨情况
- 达到补偿条件（≥4小时，≥1.5mm/h）时自动发放补偿
- weatherData 持续更新
- totalCompensation 实时累加
- 显示"持续更新中"标签

**补偿发放时效：**
- 每日补偿在 24 小时内处理完成
- 例如：11月8日触发补偿，最晚在 11月9日到账

**用户操作：**
- ❌ 不能申请退款（保障已生效）
- ✅ 联系客服
- ✅ 查看实时补偿进度

**补偿状态跟踪：**
每一天的天气数据包含详细状态：
- `无需补偿`：未下雨或降雨不足4小时
- `已到账`：补偿已发放到用户账户
- `处理中`：补偿正在处理（罕见，仅在当天监测结束后短暂出现）

---

### 4. 结算中

**状态码：** `结算中`
**状态颜色：** 琥珀色 (`bg-amber-100 text-amber-600`)

**定义：**
- 保障期的最后一天（20:00）已结束
- 最后一批补偿正在处理中，尚未全部到账

**业务规则：**
- 保障期已完全结束，不再监测新的天气数据
- weatherData 已包含所有天气记录
- 存在至少一天的补偿状态为"处理中"
- 显示"结算处理中"标签
- totalCompensation 已确定，不再变化

**补偿处理：**
- 最后一天的补偿会在 24 小时内完成
- 所有"处理中"的补偿会逐一转为"已到账"

**状态转换：**
当所有应补偿的天数都变为"已到账"状态时，订单自动转为"已完成"

**用户操作：**
- ❌ 不能申请退款
- ✅ 联系客服
- ✅ 查看补偿进度和预计到账时间

---

### 5. 已完成

**状态码：** `已完成`
**状态颜色：** 绿色 (`bg-green-100 text-green-600`)

**定义：**
- 保障期已结束
- 所有应得补偿已全部到账
- 订单完全关闭

**业务规则：**
- weatherData 包含完整的天气记录
- 所有补偿状态为"已到账"或"无需补偿"
- totalCompensation 为最终金额
- 不再有任何待处理事项

**用户操作：**
- ❌ 不能申请退款
- ✅ 联系客服
- ✅ 查看完整补偿记录

---

### 6. 已失效

**状态码：** `已失效`
**状态颜色：** 灰色 (`bg-gray-100 text-gray-500`)

**定义：**
- 订单因特殊原因失效
- 例如：用户申请了退款、订单过期未支付等

**业务规则：**
- weatherData 为空数组
- totalCompensation 为 0
- 不会进入保障期

**用户操作：**
- ✅ 联系客服（如有疑问）

---

## 二、每日补偿状态

每个保障日都有独立的补偿状态跟踪：

### 补偿状态枚举

| 状态 | 说明 | 显示标签 | 颜色 |
|------|------|---------|------|
| `无需补偿` | 未下雨或降雨不足触发条件 | "无需补偿" | 灰色 |
| `待结算` | 降雨条件已满足，等待系统结算 | 无（仅内部使用） | - |
| `处理中` | 补偿正在处理中 | "处理中" 🕐 | 琥珀色 |
| `已到账` | 补偿已成功发放到用户账户 | "已到账" ✓ | 绿色 |

### DayWeather 数据结构

```typescript
interface DayWeather {
  date: string;                    // 日期，如 "11月08日"
  rained: boolean;                 // 是否下雨
  hours?: number;                  // 降雨时长（小时）
  compensated: boolean;            // 是否触发补偿
  amount?: number;                 // 补偿金额（元）
  compensationStatus: '无需补偿' | '待结算' | '处理中' | '已到账';
  paidAt?: string;                 // 到账时间，如 "11月09日 10:32"
}
```

---

## 三、补偿规则

### 触发条件

1. **监测时段：** 每天 08:00 - 20:00
2. **降雨时长：** 累计降雨 ≥ 4 小时
3. **降雨强度：** ≥ 1.5 mm/h（地面有小水坑的程度）

### 补偿标准

- **金额：** 2 元/天
- **发放时效：** 触发当天 24 小时内到账
- **通知方式：** 短信通知

### 数据源

- 使用国家权威天气数据源
- 确保数据准确性和公正性

---

## 四、退款政策

### 可退款场景

**仅限"已支付"状态的订单可申请退款**

- ✅ 保障未开始（开始日期未到）
- ✅ 全额退款
- ✅ 1-3 个工作日原路退回

### 不可退款场景

- ❌ 保障中（保障期内）
- ❌ 结算中（保障期已结束，补偿处理中）
- ❌ 已完成（订单已关闭）
- ❌ 待支付（尚未付款，无需退款）
- ❌ 已失效（订单已失效）

### 特殊情况

如用户在保障期内或之后有退款需求，请联系客服处理。

---

## 五、订单状态流转图

```
待支付 ──支付──> 已支付 ──保障开始──> 保障中 ──保障结束──> 结算中 ──补偿全部到账──> 已完成
  │                │
  │                │ 申请退款
  │                ↓
  └─────────> 已失效
```

---

## 六、业务流程时间线

### 典型订单生命周期

1. **D-7天：** 用户创建订单（待支付）
2. **D-7天：** 用户完成支付（已支付）
3. **D日 00:00：** 保障生效（保障中）
4. **D日 - D+N日：** 每日监测天气，实时发放补偿
5. **D+N日 20:00：** 保障结束，进入结算期（结算中）
6. **D+N+1日：** 最后补偿到账（已完成）

### 补偿发放时间线

假设 11月8日 触发补偿：

- **11月8日 20:00：** 监测时段结束，确认降雨数据
- **11月8日 20:00 - 11月9日 20:00：** 补偿处理窗口
- **11月9日 10:32：** 补偿到账（实际案例）

---

## 七、用户界面说明

### 订单列表页

显示所有订单，包含：
- 订单号
- 地点
- 日期范围
- 状态标签（不同颜色区分）

### 订单详情页

根据订单状态显示不同内容：

#### 待支付
- 订单基本信息
- 补偿规则
- "立即支付"按钮

#### 已支付
- 订单基本信息
- **保障状态**卡片（等待生效，显示开始日期）
- 费用明细
- 补偿规则
- "申请退款"选项（菜单中）

#### 保障中
- 订单基本信息
- **补偿进度**（实时更新，显示"持续更新中"）
- 费用明细（显示"持续更新中"）
- 补偿规则
- "联系客服"选项（菜单中）

#### 结算中
- 订单基本信息
- **补偿进度**（显示"结算处理中"）
- 费用明细（显示"结算中"）
- 补偿规则
- "联系客服"选项（菜单中）

#### 已完成
- 订单基本信息
- 补偿进度（完整记录）
- 费用明细（最终金额）
- 补偿规则
- "联系客服"选项（菜单中）

---

## 八、技术实现要点

### 状态判断逻辑

```typescript
// 订单状态判断伪代码
function determineOrderStatus(order) {
  if (!order.paid) return '待支付';
  if (order.refunded) return '已失效';

  const today = new Date();
  const startDate = new Date(order.startDate);
  const endDate = new Date(order.endDate);

  if (today < startDate) return '已支付';
  if (today >= startDate && today <= endDate) return '保障中';

  // 保障已结束，检查补偿状态
  const hasProcessing = order.weatherData.some(
    day => day.compensationStatus === '处理中'
  );

  if (hasProcessing) return '结算中';
  return '已完成';
}
```

### 数据库设计建议

#### 订单表 (orders)
```sql
CREATE TABLE orders (
  id VARCHAR PRIMARY KEY,
  user_id VARCHAR,
  location VARCHAR,
  start_date DATE,
  end_date DATE,
  days INT,
  status VARCHAR, -- '待支付', '已支付', '保障中', '结算中', '已完成', '已失效'
  daily_price DECIMAL,
  service_fee DECIMAL,
  total_amount DECIMAL,
  total_compensation DECIMAL,
  created_at TIMESTAMP,
  paid_at TIMESTAMP,
  ...
);
```

#### 每日天气记录表 (daily_weather)
```sql
CREATE TABLE daily_weather (
  id VARCHAR PRIMARY KEY,
  order_id VARCHAR REFERENCES orders(id),
  date DATE,
  rained BOOLEAN,
  hours INT,
  compensated BOOLEAN,
  compensation_amount DECIMAL,
  compensation_status VARCHAR, -- '无需补偿', '待结算', '处理中', '已到账'
  paid_at TIMESTAMP,
  ...
);
```

---

## 九、常见问题

### Q1: 为什么需要"结算中"状态？

**A:** 保障期最后一天的补偿需要等到 20:00 监测结束后才能处理，通常会在接下来的 24 小时内到账。"结算中"状态让用户明确知道保障已结束，补偿正在处理中，避免用户困惑。

### Q2: 用户可以在保障期内取消吗？

**A:** 不可以。一旦保障开始生效，用户不能自主取消或退款。这是为了防止用户看到天气预报后选择性退款。如有特殊情况，请联系客服处理。

### Q3: 为什么补偿不是实时到账？

**A:** 补偿需要等待当天监测时段（20:00）结束后，系统才能确认最终降雨数据并处理补偿。通常在 24 小时内完成，确保数据准确性。

### Q4: 多天订单是单独结算还是统一结算？

**A:** 每天单独结算和发放补偿，不等到最后统一结算。这样用户可以更快收到补偿，提升体验。

### Q5: 如何定义"保障期已结束"？

**A:** 保障结束日期的 20:00 为监测结束时间。例如，保障期为 11月8日-11月10日，则 11月10日 20:00 后保障正式结束。

---

## 十、更新日志

### v1.0.0 (2025-11-10)
- 初始版本
- 定义 6 种订单状态
- 定义 4 种补偿状态
- 明确退款政策和业务流程

---

## 联系方式

如有任何疑问或建议，请联系产品团队或技术团队。

**文档维护：** 技术团队
**最后更新：** 2025年11月10日
